{% extends 'base.html' %}
{% block title %}Faculty Dashboard{% endblock %}
{% block content %}
<div class="page-header">
    <h1><i class="bi bi-person-badge me-2"></i>Faculty Dashboard</h1>
    <p>Monitor and review student internship progress</p>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <p>Assigned Students</p>
            <h3>{{ my_assigned_applications.count }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <p>Pending Reviews</p>
            <h3>{{ pending_logs.count }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card accent">
            <p>Completed Reviews</p>
            <h3>{{ reviewed_logs.count }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <p>Pending Applications</p>
            <h3>{{ pending_applications.count }}</h3>
        </div>
    </div>
</div>

<div class="mb-3">
    <a href="{% url 'analytics' %}" class="btn btn-primary">
        <i class="bi bi-bar-chart me-1"></i> View Analytics
    </a>
</div>

<!-- Assigned Students with Progress Monitoring -->
<div class="card mb-3">
    <div class="card-header">
        <i class="bi bi-people-fill me-2"></i>My Assigned Students ({{ assigned_students_progress|length }})
    </div>
    <div class="card-body">
        {% if assigned_students_progress %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                                <th>Student</th>
                                <th>Register No</th>
                                <th>Department</th>
                                <th>Company</th>
                                <th>Weeks Submitted</th>
                                <th>Pending Review</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in assigned_students_progress %}
                            <tr>
                                <td><strong>{{ item.student.full_name }}</strong></td>
                                <td>{{ item.student.register_number }}</td>
                                <td><span class="badge bg-secondary">{{ item.student.get_department_display }}</span></td>
                                <td>{{ item.application.company_name }}</td>
                                <td>
                                    <span class="badge bg-info">{{ item.submitted_weeks }} / {{ item.expected_weeks }}</span>
                                </td>
                                <td>
                                    {% if item.pending_weeks > 0 %}
                                    <span class="badge bg-warning">{{ item.pending_weeks }} pending</span>
                                    {% else %}
                                    <span class="badge bg-success">All reviewed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="width: 100px; height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ item.progress_pct }}%;" 
                                             aria-valuenow="{{ item.progress_pct }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ item.progress_pct }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No students assigned to you yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Two Column Layout: Pending and Reviewed -->
        <div class="row">
            <!-- PENDING SUBMISSIONS -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-hourglass-split"></i> Pending Submissions ({{ pending_logs.count }})
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        {% if pending_logs %}
                        {% for log in pending_logs %}
                        <div class="card mb-2 border-warning">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-person"></i> {{ log.student.full_name }}
                                            <small class="text-muted">({{ log.student.register_number }})</small>
                                        </h6>
                                        <p class="mb-1 small">
                                            <strong>Week {{ log.week_number }}</strong> | 
                                            {{ log.application.company_name }}
                                        </p>
                                        <p class="mb-1 small text-muted">
                                            Submitted: {{ log.submission_date|date:"M d, Y H:i" }}
                                        </p>
                                        {% if log.submission_file %}
                                        <a href="{{ log.submission_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-file-earmark-arrow-down"></i> View/Download File
                                        </a>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'review_log' log.log_id %}" class="btn btn-warning btn-sm">
                                        <i class="bi bi-pencil-square"></i> Review
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted text-center py-4">
                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i><br>
                            No pending submissions to review!
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- REVIEWED SUBMISSIONS -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-check-circle-fill"></i> Reviewed Submissions
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        {% if reviewed_logs %}
                        {% for log in reviewed_logs %}
                        <div class="card mb-2 border-success">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-person-check"></i> {{ log.student.full_name }}
                                        </h6>
                                        <p class="mb-1 small">
                                            <strong>Week {{ log.week_number }}</strong> | 
                                            {{ log.application.company_name }}
                                        </p>
                                        <p class="mb-0 small text-success">
                                            <i class="bi bi-chat-quote"></i> {{ log.faculty_feedback|truncatewords:10 }}
                                        </p>
                                    </div>
                                    <span class="badge bg-success">
                                        <i class="bi bi-check"></i> Reviewed
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted text-center py-4">No reviews completed yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Application Approvals -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-file-earmark-check"></i> Pending Application Approvals
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Register No</th>
                                <th>Department</th>
                                <th>Company</th>
                                <th>Domain</th>
                                <th>Duration</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in pending_applications %}
                            <tr class="fade-in-row">
                                <td><strong>{{ app.student.full_name }}</strong></td>
                                <td>{{ app.student.register_number }}</td>
                                <td><span class="badge bg-secondary">{{ app.student.get_department_display }}</span></td>
                                <td>{{ app.company_name }}</td>
                                <td>{{ app.internship_domain }}</td>
                                <td>{{ app.start_date|date:"M d" }} - {{ app.end_date|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <form method="post" action="{% url 'approve_application' app.application_id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <div class="mb-1">
                                                <textarea name="faculty_remarks" class="form-control" rows="2" placeholder="Feedback/Remarks (required)" required></textarea>
                                            </div>
                                            <button type="submit" name="action" value="approve" class="btn btn-sm btn-success mt-1" onclick="return confirm('Are you sure you want to approve this application?')">
                                                <i class="bi bi-check-circle"></i> Approve
                                            </button>
                                            <button type="submit" name="action" value="reject" class="btn btn-sm btn-danger mt-1" onclick="return confirm('Are you sure you want to reject this application?')">
                                                <i class="bi bi-x-circle"></i> Reject
                                            </button>
                                        </form>
                                    </div>
                                    <a href="{% url 'review_application' app.application_id %}" class="btn btn-sm btn-outline-primary ms-1">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No pending applications</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Approved Students/Applications -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-check2-circle"></i> Approved Students
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Register No</th>
                                    <th>Department</th>
                                    <th>Company</th>
                                    <th>Domain</th>
                                    <th>Duration</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in my_assigned_applications %}
                                    {% if app.application_status == 'approved' %}
                                    <tr>
                                        <td><strong>{{ app.student.full_name }}</strong></td>
                                        <td>{{ app.student.register_number }}</td>
                                        <td><span class="badge bg-secondary">{{ app.student.get_department_display }}</span></td>
                                        <td>{{ app.company_name }}</td>
                                        <td>{{ app.internship_domain }}</td>
                                        <td>{{ app.start_date|date:"M d" }} - {{ app.end_date|date:"M d, Y" }}</td>
                                        <td>
                                            <a href="{% url 'application_details' app.application_id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> View Details
                                            </a>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No approved students</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Completions -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-check2-square"></i> Pending Completion Verifications
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Company</th>
                                <th>Duration (days)</th>
                                <th>Score</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in pending_completions %}
                            <tr>
                                <td>{{ comp.student.full_name }}</td>
                                <td>{{ comp.application.company_name }}</td>
                                <td>{{ comp.total_duration }}</td>
                                <td>{{ comp.completion_score|floatformat:2 }}</td>
                                <td>
                                    <span class="badge bg-warning">Pending Verification</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <span class="text-muted">No pending verifications</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{% endblock %}
